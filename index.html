<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Directo en Navegador</title>
    <!-- Usaremos la API WebXR directamente + librería JSAR -->
    <script src="https://cdn.jsdelivr.net/npm/jsartoolkit@latest/jsartoolkit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@latest/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@latest/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #ar-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
        #scan-message {
            position: fixed;
            bottom: 20px;
            width: 100%;
            text-align: center;
            color: white;
            font-family: Arial;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="ar-container"></div>
    <div id="scan-message">Enfoca a gordinflas con tu cámara</div>

    <script>
        // 1. Configuración inicial
        const container = document.getElementById('ar-container');
        const message = document.getElementById('scan-message');
        
        // 2. Inicializar Three.js
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        // 3. Cargar modelos
        const loader = new THREE.GLTFLoader();
        let modeloLetras;

        loader.load('felicidades.glb', (gltf) => {
            modeloLetras = gltf.scene;
            modeloLetras.scale.set(0.5, 0.5, 0.5);
            modeloLetras.position.y = 0.5;
            modeloLetras.visible = false;
            scene.add(modeloLetras);
        });

        // 4. Configurar AR con marcador
        const arToolkitContext = new THREEx.ArToolkitContext({
            cameraParametersUrl: 'https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/data/camera_para.dat',
            detectionMode: 'mono',
            patternRatio: 0.5,
        });

        arToolkitContext.init(() => {
            camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
        });

        // 5. Crear marcador (usa tu imagen de oso)
        const arMarkerControls = new THREEx.ArMarkerControls(arToolkitContext, camera, {
            type: 'pattern',
            patternUrl: 'oso/oso.patt', 
            changeMatrixMode: 'cameraTransformMatrix'
        });

        arMarkerControls.addEventListener('markerFound', () => {
            if(modeloLetras) modeloLetras.visible = true;
            message.style.display = 'none';
        });

        arMarkerControls.addEventListener('markerLost', () => {
            if(modeloLetras) modeloLetras.visible = false;
            message.style.display = 'block';
        });


        // 7. Manejo de cámara
        navigator.mediaDevices.getUserMedia({ video: true })
            .then((stream) => {
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();
                arToolkitContext.arController._orientation = 'portrait';
                arToolkitContext.arController.options.orientation = 'portrait';
            })
            .catch((error) => {
                console.error("Error al acceder a la cámara:", error);
                message.textContent = "No se pudo acceder a la cámara. Asegúrate de dar permisos.";
            });
    </script>
</body>
</html>
