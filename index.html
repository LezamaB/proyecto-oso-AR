<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Funcional Definitivo</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        .arjs-loader {
            height: 100vh;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            color: white;
            font-family: Arial;
            position: absolute;
            z-index: 9999;
        }
        .model-loaded { display: none; }
    </style>
</head>
<body>
    <div class="arjs-loader" id="loader">
        <div>
            <h3>Cargando AR...</h3>
            <p id="status">Inicializando cámara</p>
        </div>
    </div>

    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono;"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
    >
        <!-- Modelo con pre-carga optimizada -->
        <a-assets>
            <a-asset-item id="model" src="model.glb"></a-asset-item>
        </a-assets>

        <!-- Marcador NFT simplificado -->
        <a-nft 
            type="nft" 
            url="nft-marker/marker"
            smooth="true"
            smoothCount="5"
        >
            <a-entity
                gltf-model="#model"
                position="0 0 0"
                scale="0.5 0.5 0.5"
                rotation="0 0 0"
                visible="true"
            ></a-entity>
        </a-nft>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // Debug avanzado
        const loader = document.getElementById('loader');
        const status = document.getElementById('status');
        
        // 1. Verificar compatibilidad
        if (!navigator.mediaDevices) {
            status.innerHTML = "ERROR: Necesitas HTTPS o localhost";
            throw new Error("Sin acceso a cámara");
        }

        // 2. Eventos de carga
        const scene = document.querySelector('a-scene');
        const model = document.querySelector('[gltf-model]');
        
        scene.addEventListener('loaded', () => {
            status.textContent = "Escena lista, buscando marcador...";
        });

        model.addEventListener('model-loaded', () => {
            status.textContent = "¡Modelo cargado correctamente!";
            setTimeout(() => loader.style.display = 'none', 1500);
            console.log("Modelo 3D cargado:", model.components['gltf-model'].model);
        });

        model.addEventListener('model-error', (e) => {
            status.innerHTML = `ERROR: Modelo no carga<br>${e.detail.message}`;
            console.error("Error modelo:", e.detail);
        });

        // 3. Forzar recarga si tarda demasiado
        setTimeout(() => {
            if (loader.style.display !== 'none') {
                status.innerHTML = "¿Problemas?<br>1. Verifica los archivos<br>2. Prueba en Chrome<br>3. Recarga la página";
            }
        }, 10000);
    </script>
</body>
</html>
